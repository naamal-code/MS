<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ペプチド分子量計算</title>

  <!-- ✅ アイコン指定（ブラウザ/ホーム画面用） -->
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png">

  <!-- ✅ manifest（この1ファイル内でJS生成して差し込み） -->
  <link rel="manifest" id="manifest-link">

  <meta name="theme-color" content="#7fff00">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root {
      --primary-color: #7fff00;
      --text-color: #7fff00;
      --border-color: #4CAF50;
      --bg-color: #000;
      --panel-bg: rgba(255,255,255,0.03);
    }

    body {
      font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      background-color: var(--bg-color);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      width: 100%;
      max-width: 900px;
      font-weight: normal;
      margin: 0 0 20px 0;
      text-align: left;
    }

    .app {
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    /* 上段：左=N/C末端、右=修飾 */
    .top-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      width: 100%;
    }

    /* アミノ酸は1枠 */
    .panel {
      border: 1px solid var(--primary-color);
      border-radius: 6px;
      padding: 14px;
      background: var(--panel-bg);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .section-label {
      font-weight: bold;
      font-size: 0.95em;
      color: white;
      margin: 0;
    }

    button {
      background-color: #fff;
      border: 1px solid var(--border-color);
      padding: 10px;
      text-align: left;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      border-radius: 4px;
      color: var(--text-color);
    }

    button:hover {
      background-color: white;
      border-color: var(--primary-color);
    }

    button:active { transform: translateY(1px); }

    button.selected {
      background-color: #e8f5e9;
      border-color: var(--primary-color);
      border-left: 5px solid var(--primary-color);
      font-weight: bold;
    }

    .count-badge {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background-color: var(--primary-color);
      color: white;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 12px;
      font-weight: bold;
      display: none;
    }
    button.selected .count-badge { display: inline-block; }

    /* ✅ クリア/計算：アミノ酸と出力の間 */
    .action-area {
      display: flex;
      gap: 12px;
      width: 100%;
    }
    .action-btn {
      flex: 1;
      text-align: center;
      border: 1px solid var(--primary-color);
      color: var(--text-color);
      padding: 12px;
    }
    .action-btn:hover {
      background-color: var(--primary-color);
      color: white;
    }

    /* 出力は最下段 */
    .results-container {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      width: 100%;
    }

    .result-box {
      border: 1px solid var(--primary-color);
      padding: 16px;
      text-align: center;
      height: 80px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      border-radius: 6px;
      background: var(--panel-bg);
    }

    .result-label {
      font-size: 0.9em;
      margin-bottom: 5px;
      color: white;
    }
    .result-value { font-size: 1.2em; font-weight: bold; }

    @media (max-width: 768px) {
      .top-grid { grid-template-columns: 1fr; }
      .results-container { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="app">
    <h1>ペプチド分子量計算</h1>

    <!-- 上段：左=N/C末端、右=修飾 -->
    <div class="top-grid">
      <div class="panel" id="panel-terminals">
        <div class="section-label">N末端 (選択1つ)</div>
        <div id="n-term-group"></div>

        <div class="section-label">C末端 (選択1つ)</div>
        <div id="c-term-group"></div>
      </div>

      <div class="panel" id="panel-mods">
        <div class="section-label">修飾</div>
        <div id="mod-group"></div>

        <div class="section-label">特殊アミノ酸</div>
        <div id="special-group"></div>
      </div>
    </div>

    <!-- ✅ アミノ酸：1枠にまとめる（アルファベット順） -->
    <div class="panel" id="panel-aa">
      <div class="section-label">アミノ酸</div>
      <div id="aa-group"></div>
    </div>

    <!-- ✅ アクション：アミノ酸と出力の間 -->
    <div class="action-area">
      <button class="action-btn" onclick="clearAll()">クリア</button>
      <button class="action-btn" onclick="calculate()">計算</button>
    </div>

    <!-- 出力 -->
    <div class="results-container">
      <div class="result-box">
        <span class="result-label">分子量</span>
        <span class="result-value" id="res-mw">---</span>
      </div>
      <div class="result-box">
        <span class="result-label">2+</span>
        <span class="result-value" id="res-plus2">---</span>
      </div>
      <div class="result-box">
        <span class="result-label">3+</span>
        <span class="result-value" id="res-plus3">---</span>
      </div>
    </div>
  </div>

  <script>
    // manifest をこの1ファイル内で生成して差し込み
    (function attachManifest() {
      const manifest = {
        name: "ペプチド分子量計算",
        short_name: "MW Calc",
        start_url: "./",
        display: "standalone",
        background_color: "#000000",
        theme_color: "#7fff00",
        icons: [
          { src: "icons/icon-192.png", sizes: "192x192", type: "image/png" },
          { src: "icons/icon-512.png", sizes: "512x512", type: "image/png" },
          { src: "icons/icon-512-maskable.png", sizes: "512x512", type: "image/png", purpose: "maskable" }
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      document.getElementById("manifest-link").setAttribute("href", url);
    })();

    // --- データ定義 ---
    const aminoAcids1 = [
      { name: "Ala", val: 71.07 }, { name: "Arg", val: 156.18 },
      { name: "Asn", val: 114.1 }, { name: "Asp", val: 115.08 },
      { name: "Cys", val: 103.14 }, { name: "Gln", val: 128.13 },
      { name: "Glu", val: 129.11 }, { name: "Gly", val: 57.05 },
      { name: "His", val: 137.13 }, { name: "Ile", val: 113.15 }
    ];

    const aminoAcids2 = [
      { name: "Leu", val: 113.15 }, { name: "Lys", val: 128.17 },
      { name: "Met", val: 131.19 }, { name: "Phe", val: 147.17 },
      { name: "Pro", val: 97.11 },  { name: "Ser", val: 87.07 },
      { name: "Thr", val: 101.1 }, { name: "Trp", val: 186.21 },
      { name: "Tyr", val: 163.17 }, { name: "Val", val: 99.13 }
    ];

    // ✅ まとめたアミノ酸（アルファベット順）
    const aminoAcids = [...aminoAcids1, ...aminoAcids2].sort((a, b) =>
      a.name.localeCompare(b.name)
    );

    const specials = [
      { name: "Hyp", val: 113.11 }, { name: "Aib", val: 85.1 },
      { name: "Phg", val: 133.15 }, { name: "Cha", val: 153.22 },
      { name: "Nal", val: 197.23 }
    ];

    const modifications = [
      { name: "H → CH3", val: 14.03 }, { name: "H → F", val: 17.99 },
      { name: "H → Cl", val: 34.44 },  { name: "H → NO2", val: 45.00 },
      { name: "H → N3", val: 41.02 }
    ];

    const nTerminals = [
      { name: "H", val: 1.01 },     { name: "Fmoc", val: 223.26 },
      { name: "Boc", val: 101.13 }, { name: "Ac", val: 43.05 }
    ];

    const cTerminals = [
      { name: "OH", val: 17.01 },   { name: "NH2", val: 16.03 }
    ];

    // --- 状態管理 ---
    let counts = {};
    let selectedNTerm = null;
    let selectedCTerm = null;

    // --- 初期化 ---
    function init() {
      renderButtons("n-term-group", nTerminals, "radio-n");
      renderButtons("c-term-group", cTerminals, "radio-c");

      renderButtons("mod-group", modifications, "count");
      renderButtons("special-group", specials, "count");

      // ✅ アミノ酸は1グループだけ
      renderButtons("aa-group", aminoAcids, "count");
    }

    function renderButtons(containerId, dataList, type) {
      const container = document.getElementById(containerId);

      dataList.forEach(item => {
        const btn = document.createElement("button");
        btn.innerHTML = `${item.name} <span class="count-badge" id="badge-${cleanId(item.name)}">0</span>`;
        btn.id = `btn-${cleanId(item.name)}`;

        if (type === "count") {
          // 既存があれば上書きしない（同名が来ても壊れにくく）
          if (counts[item.name] === undefined) counts[item.name] = 0;

          btn.onclick = () => {
            counts[item.name]++;
            updateButtonDisplay(item.name);
          };
        } else if (type === "radio-n") {
          btn.onclick = () => {
            selectedNTerm = (selectedNTerm === item) ? null : item;
            updateRadioDisplay(nTerminals, selectedNTerm);
          };
        } else if (type === "radio-c") {
          btn.onclick = () => {
            selectedCTerm = (selectedCTerm === item) ? null : item;
            updateRadioDisplay(cTerminals, selectedCTerm);
          };
        }

        container.appendChild(btn);
      });
    }

    function cleanId(str) {
      return str.replace(/[^a-zA-Z0-9]/g, '');
    }

    function updateButtonDisplay(name) {
      const btn = document.getElementById(`btn-${cleanId(name)}`);
      const badge = document.getElementById(`badge-${cleanId(name)}`);
      const count = counts[name];

      if (count > 0) {
        btn.classList.add("selected");
        badge.innerText = count;
      } else {
        btn.classList.remove("selected");
        badge.innerText = 0;
      }
    }

    function updateRadioDisplay(list, selectedItem) {
      list.forEach(item => {
        const btn = document.getElementById(`btn-${cleanId(item.name)}`);
        if (selectedItem && item.name === selectedItem.name) btn.classList.add("selected");
        else btn.classList.remove("selected");
      });
    }

    // --- 計算処理 ---
    function calculate() {
      let totalWeight = 0;

      if (selectedNTerm) totalWeight += selectedNTerm.val;
      if (selectedCTerm) totalWeight += selectedCTerm.val;

      [...aminoAcids, ...specials, ...modifications].forEach(item => {
        const count = counts[item.name] || 0;
        totalWeight += item.val * count;
      });

      const mw = parseFloat(totalWeight.toFixed(2));
      const plus2 = (mw + 2) / 2;
      const plus3 = (mw + 3) / 3;

      document.getElementById("res-mw").innerText = mw.toFixed(2);
      document.getElementById("res-plus2").innerText = plus2.toFixed(2);
      document.getElementById("res-plus3").innerText = plus3.toFixed(2);
    }

    // --- クリア処理 ---
    function clearAll() {
      for (let key in counts) {
        counts[key] = 0;
        updateButtonDisplay(key);
      }

      selectedNTerm = null;
      selectedCTerm = null;
      updateRadioDisplay(nTerminals, null);
      updateRadioDisplay(cTerminals, null);

      document.getElementById("res-mw").innerText = "---";
      document.getElementById("res-plus2").innerText = "---";
      document.getElementById("res-plus3").innerText = "---";
    }

    init();
    // ✅ オフライン対応：Service Worker 登録
if ("serviceWorker" in navigator) {
  window.addEventListener("load", async () => {
    try {
      await navigator.serviceWorker.register("./sw.js");
      // console.log("Service Worker registered");
    } catch (err) {
      console.warn("Service Worker registration failed:", err);
    }
  });
}

  </script>
</body>
</html>

